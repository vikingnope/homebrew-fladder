name: Update Fladder Cask

on:
  workflow_dispatch:

jobs:
  update-cask:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Get latest Fladder release
        id: latest_release
        run: |
          # Fetch the full release JSON
          JSON=$(curl -s https://api.github.com/repos/DonutWare/Fladder/releases/latest)
          
          # Extract version and tag
          LATEST=$(echo "$JSON" | jq -r .tag_name)
          VERSION=${LATEST#v}
          
          # Extract SHA256 from the asset's 'digest' field provided by the API
          # We search for the specific macOS dmg file and strip the 'sha256:' prefix
          SHA256=$(echo "$JSON" | jq -r --arg v "$VERSION" '.assets[] | select(.name == "Fladder-macOS-" + $v + ".dmg") | .digest // ""')
          SHA256="${SHA256#sha256:}"
          
          # Extract and format the release date (e.g., December 13, 2025)
          PUBLISHED_AT=$(echo "$JSON" | jq -r .published_at)
          RELEASE_DATE=$(date -d "$PUBLISHED_AT" +"%B %d, %Y")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Check current version
        id: current_version
        run: |
          CURRENT=$(grep 'version' Casks/fladder.rb | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Update files
        if: steps.latest_release.outputs.version != steps.current_version.outputs.version
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          SHA256="${{ steps.latest_release.outputs.sha256 }}"
          RELEASE_DATE="${{ steps.latest_release.outputs.date }}"
          
          if [ -z "$SHA256" ]; then
            echo "Error: Could not retrieve SHA256 digest from GitHub API."
            exit 1
          fi
          
          # Update Cask
          sed -i "s/version \".*\"/version \"$VERSION\"/" Casks/fladder.rb
          sed -i "s/sha256 \".*\"/sha256 \"$SHA256\"/" Casks/fladder.rb
          
          # Update README
          sed -i "s/- \*\*Current Version:\*\* .*/- **Current Version:** $VERSION/" README.md
          sed -i "s/- \*\*Release Date:\*\* .*/- **Release Date:** $RELEASE_DATE/" README.md

      - name: Create Pull Request
        if: steps.latest_release.outputs.version != steps.current_version.outputs.version
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          commit-message: "Update Fladder to ${{ steps.latest_release.outputs.version }}"
          title: "Update Fladder to ${{ steps.latest_release.outputs.version }}"
          body: |
            Automated update to Fladder ${{ steps.latest_release.outputs.version }}
            
            Release notes: https://github.com/DonutWare/Fladder/releases/tag/${{ steps.latest_release.outputs.tag }}
          branch: chore/update-fladder-${{ steps.latest_release.outputs.version }}
          delete-branch: true